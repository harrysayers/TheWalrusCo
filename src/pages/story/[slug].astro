---
import { getStoryBySlug } from '../../utils/notion';

const { slug } = Astro.params;

// Check if URL has trailing slash, if not redirect to add it
if (!Astro.url.pathname.endsWith('/')) {
  return Astro.redirect(`/story/${slug}/`, 301);
}

// Get story metadata from Notion to find its standalone URL
const story = await getStoryBySlug(slug);

if (!story || !story.data.standaloneUrl) {
  return new Response('Story not found', { status: 404 });
}

// Fetch the story HTML from Vercel Blob or external URL
try {
  const response = await fetch(story.data.standaloneUrl);

  if (!response.ok) {
    return new Response('Story not found', { status: 404 });
  }

  const html = await response.text();

  return new Response(html, {
    status: 200,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Cache-Control': 'public, max-age=3600, s-maxage=3600, stale-while-revalidate=86400'
    },
  });
} catch (error) {
  console.error(`Error fetching story ${slug}:`, error);
  return new Response('Story not found', { status: 404 });
}
---
