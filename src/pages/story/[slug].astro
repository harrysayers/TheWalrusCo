---
import { getStoryBySlug } from '../../utils/notion';

const { slug } = Astro.params;

// Check if URL has trailing slash, if not redirect to add it
if (!Astro.url.pathname.endsWith('/')) {
  return Astro.redirect(`/story/${slug}/`, 301);
}

// Get story metadata from Notion
const story = await getStoryBySlug(slug);

if (!story) {
  return new Response('Story not found', { status: 404 });
}

// Construct the blob URL from the slug
const blobUrl = `https://qwhrs43zjmto7km3.public.blob.vercel-storage.com/story/${slug}/index.html`;

// Fetch the story HTML from Vercel Blob
try {
  const response = await fetch(blobUrl);

  if (!response.ok) {
    return new Response('Story not found', { status: 404 });
  }

  let html = await response.text();

  // Rewrite asset paths to point to blob storage
  const blobBaseUrl = `https://qwhrs43zjmto7km3.public.blob.vercel-storage.com/story/${slug}`;

  // Replace all relative paths in attributes (src="./...", href="./...")
  html = html.replace(/(src|href)="\.\//g, `$1="${blobBaseUrl}/`);

  // Replace all relative paths in strings (including script content, JSON, etc)
  // This catches "./_next/..." in inline scripts and JSON payloads
  html = html.replace(/"\.\/_next\//g, `"${blobBaseUrl}/_next/`);
  html = html.replace(/'\.\/_next\//g, `'${blobBaseUrl}/_next/`);

  // Fix favicon absolute path
  html = html.replace(/\/favicon\.ico/g, `${blobBaseUrl}/favicon.ico`);

  return new Response(html, {
    status: 200,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Cache-Control': 'public, max-age=3600, s-maxage=3600, stale-while-revalidate=86400'
    },
  });
} catch (error) {
  console.error(`Error fetching story ${slug}:`, error);
  return new Response('Story not found', { status: 404 });
}
---
